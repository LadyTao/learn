<svg id="kity_svg_6" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1615" height="665" style="background: rgb(251, 251, 251); visibility: visible;" viewBox="0 0 1615 665"><defs id="kity_defs_7"><linearGradient id="kity_linearGradient_17" x1="0" y1="0" x2="0" y2="1"><stop id="kity_stop_18" offset="0" stop-color="rgb(255, 255, 255)"></stop><stop id="kity_stop_19" offset="1" stop-color="rgb(204, 204, 204)"></stop></linearGradient><marker id="kity_marker_2" orient="auto" refX="6" refY="0" viewBox="-7 -7 14 14" markerWidth="7" markerHeight="7" markerUnits="userSpaceOnUse"><path id="kity_path_3" fill="rgb(115, 161, 191)" stroke="none" d="M6,0A6,6,0,1,1,-6,0A6,6,0,1,1,6,0"></path></marker></defs><g id="kity_g_8"><g id="minder1" text-rendering="optimize-speed"><g id="minder_connect_group1"><path id="kity_path_31" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M91.00000414997339,264.50000313669443A192.5,102,0,0,1,283.5000041499734,162.50000313669443"></path><path id="kity_path_39" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M91.00000414997339,264.50000313669443A203.5,210,0,0,0,294.5000041499734,474.50000313669443"></path><path id="kity_path_89" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M355.5000041499734,162.50000313669443C370.5000041499734,162.50000313669443,370.5000041499734,44.50000313669443,385.5000041499734,44.50000313669443L550.5000041499734,44.50000313669443"></path><path id="kity_path_90" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M355.5000041499734,162.50000313669443C370.5000041499734,162.50000313669443,370.5000041499734,204.50000313669443,385.5000041499734,204.50000313669443L1577.5000041499734,204.50000313669443"></path><path id="kity_path_91" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M355.5000041499734,162.50000313669443C370.5000041499734,162.50000313669443,370.5000041499734,256.50000313669443,385.5000041499734,256.50000313669443L473.5000041499734,256.50000313669443"></path><path id="kity_path_96" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M382.5000041499734,474.50000313669443C412.0000041499734,474.50000313669443,412.0000041499734,518.5000031366944,441.5000041499734,518.5000031366944L1595.5000041499734,518.5000031366944"></path><path id="kity_path_98" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M382.5000041499734,474.50000313669443C412.5000041499734,474.50000313669443,412.5000041499734,644.5000031366944,442.5000041499734,644.5000031366944L530.5000041499734,644.5000031366944"></path><path id="kity_path_106" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M382.5000041499734,474.50000313669443C415.0000041499734,474.50000313669443,415.0000041499734,384.50000313669443,447.5000041499734,384.50000313669443L541.5000041499734,384.50000313669443"></path><path id="kity_path_114" fill="none" stroke="rgb(115, 161, 191)" stroke-width="1" d="M355.5000041499734,162.50000313669443C370.5000041499734,162.50000313669443,370.5000041499734,308.50000313669443,385.5000041499734,308.50000313669443L471.5000041499734,308.50000313669443"></path></g><g id="minder_node1"><path id="node_outline1" fill="rgb(115, 161, 191)" stroke="rgb(57, 80, 96)" d="M25.500004149973392,244.50000313669443h131a5,5,0,0,1,5,5v30a5,5,0,0,1,-5,5h-131a5,5,0,0,1,-5,-5v-30a5,5,0,0,1,5,-5z" stroke-width="3"></path><g id="node_text1" fill="white"><text id="kity_text_22" text-rendering="inherit" font-size="16" dy=".8em" y="254.10000310093164" x="44.50000414997339">map/reduce</text></g></g><g id="kity_g_14" display="none"><path id="kity_path_15" fill="rgba(0, 92, 153, 0.5)" stroke="none" d="M451.5000041499734,419.50000313669443h1144v15h-1144z"></path><path id="kity_path_16" fill="none" stroke="rgb(0, 76, 128)" d="M451.5000041499734,434.50000313669443L1595.5000041499734,434.50000313669443" stroke-width="1"></path></g><g id="minder_node2" opacity="1"><g id="node_expander4" style="cursor: pointer;"><path id="kity_path_76" fill="white" stroke="gray" d="M284.5000076368451,162.500001616776A6,6,0,1,1,272.5000076368451,162.500001616776A6,6,0,1,1,284.5000076368451,162.500001616776"></path><path id="kity_path_77" fill="none" stroke="gray" d="M274.0000076368451,162.500001616776L283.0000076368451,162.500001616776"></path></g><path id="node_outline5" fill="rgb(238, 243, 246)" stroke="rgb(115, 161, 191)" d="M288.50000803917646,149.500001616776h64a3,3,0,0,1,3,3v20a3,3,0,0,1,-3,3h-64a3,3,0,0,1,-3,-3v-20a3,3,0,0,1,3,-3z" stroke-width="1"></path><g id="node_text5" fill="black"><text id="kity_text_55" text-rendering="inherit" font-size="14" dy=".8em" y="153.40000158548355" x="305.50000803917646">map</text></g></g><g id="minder_node6" opacity="1"><g id="node_expander6" style="cursor: pointer;"><path id="kity_path_82" fill="white" stroke="gray" d="M395.500009290874,474.5000062659383A6,6,0,1,1,383.500009290874,474.5000062659383A6,6,0,1,1,395.500009290874,474.5000062659383"></path><path id="kity_path_83" fill="none" stroke="gray" d="M385.000009290874,474.5000062659383L394.000009290874,474.5000062659383"></path></g><path id="node_outline7" fill="rgb(238, 243, 246)" stroke="rgb(115, 161, 191)" d="M299.50000820308924,461.5000062659383h80a3,3,0,0,1,3,3v20a3,3,0,0,1,-3,3h-80a3,3,0,0,1,-3,-3v-20a3,3,0,0,1,3,-3z" stroke-width="1"></path><g id="node_text7" fill="black"><text id="kity_text_59" text-rendering="inherit" font-size="14" dy=".8em" y="465.40000623464584" x="316.50000820308924">reduce</text></g></g><g id="minder_node3"><g id="node_expander1" style="cursor: pointer;" display="none"><path id="kity_path_67" fill="white" stroke="gray" d="M395.500009290874,30.499999649822712A6,6,0,1,1,383.500009290874,30.499999649822712A6,6,0,1,1,395.500009290874,30.499999649822712"></path><path id="kity_path_68" fill="none" stroke="gray"></path></g><path id="node_outline2" fill="none" stroke="none" d="M400.5000095292926,19.499999649822712h145a5,5,0,0,1,5,5v12a5,5,0,0,1,-5,5h-145a5,5,0,0,1,-5,-5v-12a5,5,0,0,1,5,-5z"></path><g id="node_text2" fill="black"><text id="kity_text_43" text-rendering="inherit" font-size="12" dy=".8em" y="22.699999623000622" x="405.5000095292926">每个map处理的文件大小</text></g></g><g id="minder_node4"><g id="node_expander2" style="cursor: pointer;" display="none"><path id="kity_path_70" fill="white" stroke="gray" d="M395.500009290874,136.5000012293458A6,6,0,1,1,383.500009290874,136.5000012293458A6,6,0,1,1,395.500009290874,136.5000012293458"></path><path id="kity_path_71" fill="none" stroke="gray"></path></g><path id="node_outline3" fill="none" stroke="none" d="M400.5000095292926,71.5000012293458h1172a5,5,0,0,1,5,5v120a5,5,0,0,1,-5,5h-1172a5,5,0,0,1,-5,-5v-120a5,5,0,0,1,5,-5z"></path><g id="node_text3" fill="black"><text id="kity_text_45" text-rendering="inherit" font-size="12" dy=".8em" y="74.70000120252371" x="405.5000095292926">map流程</text><text id="kity_text_46" text-rendering="inherit" font-size="12" dy=".8em" y="92.70000120252371" x="405.5000095292926">1. map逻辑执行：inputsplit（注意区分splitable）等处理读取的数据位置，按照`mapper`逻辑进行处理，输出到Partitioner。</text><text id="kity_text_47" text-rendering="inherit" font-size="12" dy=".8em" y="110.70000120252371" x="405.5000095292926">2. partition 阶段：mapper 函数处理后，通过`Partitioner`根据`hash(map key)%reduce number`写入到对应的`buffer 环中`，`buffer 环`个数与`reduce`个数一致（buffer 大小由`mapreduce.task.io.sort.mb`控制）。</text><text id="kity_text_48" text-rendering="inherit" font-size="12" dy=".8em" y="128.7000012025237" x="405.5000095292926">3. spill阶段：当`buffer 环`内存使用满足一定比率(mapreduce.map.sort.spill.percent控制),执行排序，排序后文件输出到`mapreduce.job.local.dir`中暂存。</text><text id="kity_text_49" text-rendering="inherit" font-size="12" dy=".8em" y="146.7000012025237" x="405.5000095292926">4. combine开启：假如开启`combine`会在`spill阶段`排序后执行`combine`操作(相当于map agg)，`combine`可以通过`min.num.spill.for.combine`控制，即当`spill`文件达到一定数量时，提前触发运算。</text><text id="kity_text_50" text-rendering="inherit" font-size="12" dy=".8em" y="164.7000012025237" x="405.5000095292926">5. Merge 阶段：前面步骤都执行完成后，最终会把`spill`文件进行归并排序处理，输出唯一map文件，通过`mapreduce.task.io.sort.factor`控制同时合并文件的并发数。</text><text id="kity_text_51" text-rendering="inherit" font-size="12" dy=".8em" y="182.7000012025237" x="405.5000095292926">6. Compress: 开启压缩，减少io消耗。`mapreduce.map.output.compress`，`mapreduce.map.output.compress.codec`；参数控制。</text></g></g><g id="minder_node5"><g id="node_expander3" style="cursor: pointer;" display="none"><path id="kity_path_73" fill="white" stroke="gray" d="M395.500009290874,242.50000280886889A6,6,0,1,1,383.500009290874,242.50000280886889A6,6,0,1,1,395.500009290874,242.50000280886889"></path><path id="kity_path_74" fill="none" stroke="gray"></path></g><path id="node_outline4" fill="none" stroke="none" d="M400.5000095292926,231.50000280886889h68a5,5,0,0,1,5,5v12a5,5,0,0,1,-5,5h-68a5,5,0,0,1,-5,-5v-12a5,5,0,0,1,5,-5z"></path><g id="node_text4" fill="black"><text id="kity_text_53" text-rendering="inherit" font-size="12" dy=".8em" y="234.7000027820468" x="405.5000095292926">- 优化参数</text></g></g><g id="minder_node7" opacity="1"><g id="node_expander5" style="cursor: pointer;" display="none"><path id="kity_path_79" fill="white" stroke="gray" d="M1607.5000273510814,477.50000631064177A6,6,0,1,1,1595.5000273510814,477.50000631064177A6,6,0,1,1,1607.5000273510814,477.50000631064177"></path><path id="kity_path_80" fill="none" stroke="gray"></path></g><path id="node_outline6" fill="none" stroke="none" d="M456.5000103637576,439.50000631064177h1134a5,5,0,0,1,5,5v66a5,5,0,0,1,-5,5h-1134a5,5,0,0,1,-5,-5v-66a5,5,0,0,1,5,-5z" stroke-width="3"></path><g id="node_text6" fill="black"><text id="kity_text_57" text-rendering="inherit" font-size="12" dy=".8em" y="442.7000062838197" x="461.5000103637576">reduce流程</text><text id="kity_text_84" text-rendering="inherit" font-size="12" dy=".8em" y="460.7000062838197" x="461.5000103637576">1. Copy阶段：启动独立的jvm,从map中按照不同的分区路由复制到节点中，复制过程会类似的先放入内存，后写入到磁盘上，内存通过mapreduce.reduce.shuffle.input.buffer.percent(reduce总内存比率)控制。</text><text id="kity_text_85" text-rendering="inherit" font-size="12" dy=".8em" y="478.7000062838197" x="461.5000103637576">2. Merge阶段: 将输入排序，并行执行边输入，边排序，最终形成一个唯一的文件。</text><text id="kity_text_86" text-rendering="inherit" font-size="12" dy=".8em" y="496.7000062838197" x="461.5000103637576">3. reduce逻辑执行：唯一文件执行reduce处理逻辑。</text></g></g><g id="minder_node8" opacity="1"><g id="node_expander7" style="cursor: pointer;" display="none"><path id="kity_path_103" fill="white" stroke="gray" d="M542.5000114813447,630.5000085905194A6,6,0,1,1,530.5000114813447,630.5000085905194A6,6,0,1,1,542.5000114813447,630.5000085905194"></path><path id="kity_path_104" fill="none" stroke="gray"></path></g><path id="node_outline8" fill="none" stroke="none" d="M457.50001037865877,619.5000085905194h68a5,5,0,0,1,5,5v12a5,5,0,0,1,-5,5h-68a5,5,0,0,1,-5,-5v-12a5,5,0,0,1,5,-5z" stroke-width="3"></path><g id="node_text8" fill="black"><text id="kity_text_100" text-rendering="inherit" font-size="12" dy=".8em" y="622.7000085636973" x="462.50001037865877">- 优化参数</text></g></g><g id="minder_node9" opacity="1"><g id="node_expander8" style="cursor: pointer;" display="none"><path id="kity_path_111" fill="white" stroke="gray" d="M553.5000116452575,370.5000047162175A6,6,0,1,1,541.5000116452575,370.5000047162175A6,6,0,1,1,553.5000116452575,370.5000047162175"></path><path id="kity_path_112" fill="none" stroke="gray"></path></g><path id="node_outline9" fill="none" stroke="none" d="M462.5000104531646,359.5000047162175h74a5,5,0,0,1,5,5v12a5,5,0,0,1,-5,5h-74a5,5,0,0,1,-5,-5v-12a5,5,0,0,1,5,-5z" stroke-width="3"></path><g id="node_text9" fill="black"><text id="kity_text_108" text-rendering="inherit" font-size="12" dy=".8em" y="362.7000046893954" x="467.5000104531646">reduce个数</text></g></g><g id="kity_g_12" display="none"><path id="kity_path_13" fill="none" stroke="rgb(66, 94, 112)" d="M456.5000041499734,439.50000313669443h1134a5,5,0,0,1,5,5v66a5,5,0,0,1,-5,5h-1134a5,5,0,0,1,-5,-5v-66a5,5,0,0,1,5,-5z" stroke-width="5"></path></g><g id="minder_node10"><g id="node_expander9" style="cursor: pointer;" display="none"><path id="kity_path_119" fill="white" stroke="gray" d="M395.500009290874,294.50000358372927A6,6,0,1,1,383.500009290874,294.50000358372927A6,6,0,1,1,395.500009290874,294.50000358372927"></path><path id="kity_path_120" fill="none" stroke="gray"></path></g><path id="node_outline10" fill="none" stroke="none" d="M400.5000095292926,283.50000358372927h66a5,5,0,0,1,5,5v12a5,5,0,0,1,-5,5h-66a5,5,0,0,1,-5,-5v-12a5,5,0,0,1,5,-5z" stroke-width="3"></path><g id="node_text10" fill="black"><text id="kity_text_116" text-rendering="inherit" font-size="12" dy=".8em" y="286.7000035569072" x="405.5000095292926">-map个数</text></g></g></g></g></svg>