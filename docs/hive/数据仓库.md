# 数据仓库

> reference:
>
> https://help.aliyun.com/document_detail/114447.html
>
> https://www.iequa.com/2020/08/01/dataware/dw-wy-1-basic/

## 1. 数据仓库知识

	数据仓库两大流派：`Bill inmon` 和`kimball`。

- Bill inmon(数据源->数据仓库->数据集市)

  自顶向下，符合`3nf`。数据稳定，数据关系复杂，一般从`oltp`同步数据。

- kimball（数据集市->数据仓库>数据源）

  自底向上，以任务为导向。在得到数据后需要先做数据的探索，尝试将数据按照目标先拆分出不同的表需求。

### 1.1数据仓库概念

- 数据仓库：所有数据的物理存放位置
- 数据集市：针对某一业务，从数据仓库中建立的数据子集，只关注某一业务



### 1.2建模术语

> https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%B8%89%E6%AD%A3%E8%A6%8F%E5%8C%96
>
> 

- cube（立方体）：一般是表加上时间的维度，组成一个三维空间。
- 维度: 变量
- 度量：sum count distinct 
- 下钻与上卷：下钻头：查看明细。上卷：更抽象的层面。如：本层是商品，上卷就是查看商品类目。
- 切片与切块：选定一个固定的维度总览一定范围的数据就是切皮。切块的区别是选择多个维度。
- 数据模型泛化：从低维度到高维度泛化。(如年龄10到20，划分为青年)

- 旋转：`select`语句改变展示列顺序
- 3nf:

>**1NF的定义为：符合1NF的关系中的每个属性都不可再分。**(如 : 不存在合并列的表格)
>
>> 1nf缺点：数据冗余，插入异常，修改异常，删除异常。
>
>**2NF的定义为：满足1NF,表中的字段必须完全依赖于全部主键而非部分主键(非主键列必须依赖于主键，不能依赖于主键的一部分) **
>
>**3NF的定义：第二范式（2NF）的基础上，每个非主属性不依赖于其它非主属性**(非主键列必须直接依赖于主键，不能存在传递依赖。即不能存在：非主键列 A 依赖于非主键列 B，非主键列 B 依赖于主键的情况。)



### 1.3星型vs雪花模型

- 星型模型

中央一个事实表，外围关联一层维度表。不遵守`3nf`

- 雪花模型

中央一个事实表，外围关联一层，或者一层以上维度表。雪花模型是遵守`3nf`。



### 1.4 事实表vs维度表

![img](https://pic2.zhimg.com/80/v2-8891003587fdddff732ada835f878a3d_720w.jpg)

![dim_dwd](https://github.com/Whojohn/learn/blob/master/docs/hive/pic/dim_dwd_relation.jpg?raw=true)

```text
如：小明 2020年4月19日下午3点20分 在 海底捞(万达广场) 吃了5道菜，每道菜的单价是4元，总价是20元。
事实表 ：餐饮过程，单价、数量、总价。
维度表 ：小明，餐饮时间，餐饮门店，菜名。
```



- 维度表

描述特定范围的维度信息，如上图蓝色表

- 事实表

描述事务的最小单位，如上图红色表；

> 事实表按照粒度又可以分为：
>
> 1. 事务事实表(每一个操作一条记录)
> 2. 周期性事实表(库存事实表)
> 3. 累积快照事实表(跟踪整个改变的过程)



### 1.5 维度表维护问题(缓慢变化维)

- 缓慢(快速)变化维度：会改变的维度：如用户的性别，用户的头像，用户订单状态。

变化维度的难点：

> reference:
>
> https://zhuanlan.zhihu.com/p/336501748
>
> https://en.wikipedia.org/wiki/Slowly_changing_dimension

以下变更就是缓慢变化维度特性，随着时间维度会改变。

存在问题：

1. 源码`id`唯一，原表中不会记录历史数据。
2. 数仓中历史数据是否需要保证历史数据。
3. 没有更新时间，处理时不知道如何选定值。

| id   | user_id  | name | department |
| ---- | -------- | ---- | ---------- |
| 1    | 183XXX89 | tom  | ui         |

| id   | user_id  | name | department |
| ---- | -------- | ---- | ---------- |
| 1    | 183XXX89 | tom  | analysis   |

解决办法：

**对于不需要历史状态的业务**：

方法1：只保留最新的状态

| id   | user_id  | name | department |
| ---- | -------- | ---- | ---------- |
| 1    | 183XXX89 | tom  | analysis   |

方法2：只保留刚开始的状态

**对于需要保留历史状态的业务**

方法1：表中带有`update`时间（需要业务方配置，或者从`cdc`日志中捕获改变的时间）

| id   | user_id  | name | department | create_time | update_time                    |
| ---- | -------- | ---- | ---------- | ----------- | ------------------------------ |
| 1    | 183XXX89 | tom  | ui         | 2021/11/01  | 2021/11/02                     |
| 1    | 183XXX89 | tom  | analysis   | 2021/11/02  | 9999/11/03（方便join时候运算） |

方法2：使用`代理键`，如所需的连接表中和维度表中都记录这种历史状态；所谓的代理键位就是业务标识历史状态。虽然这个需要业务配合，但是能够节省存储和提高性能。

| id   | user_id  | name | department |
| ---- | -------- | ---- | ---------- |
| 1    | 183XXX89 | tom  | ui         |
| 2    | 183XXX89 | tom  | analysis   |



## 2数据仓库分层

>  reference:
>
> https://help.aliyun.com/document_detail/126215.html
>
> 

### 2.1 阿里的划分方式：

ods（接入层） -> cdm（数据公共层） -> ads（数据应用层）

- 数据引入层ODS（Operation Data Store）：存放未经过处理的原始数据至数据仓库系统，结构上与源系统保持一致，是数据仓库的数据准备区，记录基础数据的变化的最详细粒度。

- 数据公共层CDM（Common Data Model，又称通用数据模型层），包括DIM维度表、DWD和DWS，由ODS层数据加工而成。主要完成数据加工与整合，建立一致性的维度，构建可复用的面向分析和统计的明细事实表，以及汇总公共粒度的指标。

  > 公共维度层（DIM）：基于维度建模理念思想，建立统一维度明细。降低数据计算口径和算法不统一风险。dim 层也负责数据的`etl`。
  >
  > 明细粒度事实层（DWD）：构建最细粒度的明细层事实表，一般会配合宽表实现。
  >
  > 公共汇总粒度事实层（DWS）：构建口径一致的统计指标，为上层提供公共指标，通过`dim`和`dwd`构以特定维度构建的表。注意，正常情况下，`dws`只能是单个事实表衍生的。

- 数据应用层ADS（Application Data Service）：存放数据产品个性化的统计指标数据。根据CDM与ODS层加工生成。一般是强业务相关，由多个`dwd`或者是`dws`构成。

![数仓层次关系图](https://github.com/Whojohn/learn/blob/master/docs/hive/pic/ali_datawarehouse_model.png?raw=true)

### 2.2 数仓内部划分方式

从数据源录入到使用：

1. 数据明细层：DWD（Data Warehouse Detail）数据来源于日志，数据库等各种来源入库。

2. 数据中间层：DWM（Data WareHouse Middle）数据清洗，预处理
3. 数据服务层：DWS（Data WareHouse Servce）建立详细事实表